name: Autoupdate

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:


jobs:
  autoupdate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        sudo pip3 install setuptools wheel
        sudo pip3 install yq
        pip3 install -r scripts/requirements.txt
    - name: Run autoupdate
      run: |
        git config user.email "actions@github.com"
        git config user.name "Github Actions"
        git fetch origin
        
        for file in manifests/*
        do
          git reset --hard master
          ./scripts/autoupdate.py "$file"
          
          if [[ `git status --porcelain` ]]; then
            echo "Things have changed, attempting to create a PR"
            git status
            
            version=$(cat "$file" | yq -r ".version") # "1.5.3"
            filename=${file##*/} # "Plugin Name.yml"
            name=${filename%.*} # "Plugin Name"
            branchname=$(echo "auto/$name/$version" | sed 's/[^\w\d]/_/g') # "auto/Plugin_Name/1_5_3"
            
            if git branch -al | grep -F "remotes/origin/$branchname" > /dev/null; then
              echo "Branch $branchname already exists, discarding changes"
              git restore manifests/

            else
              git checkout -B "$branchname"
              git add manifests/
              git commit -m "Update $name to $version"
              git push --set-upstream origin "$branchname"

              # the poor man's "does this PR exist?"
              if ! gh pr ready "$branchname"; then
                gh pr create --fill --label Autoupdate
              fi

            fi

            git checkout master
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
