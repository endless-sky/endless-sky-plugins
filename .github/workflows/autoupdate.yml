name: Autoupdate

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:


jobs:
  autoupdate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        sudo pip3 install setuptools wheel
        sudo pip3 install yq
        pip3 install -r scripts/requirements.txt
    - name: Run autoupdate
      run: |
        git config user.email "actions@github.com"
        git config user.name "Github Actions"
        for file in manifests/*
        do
          ./scripts/autoupdate.py "$file"
          
          if ! git diff-index --quiet HEAD --; then # if something has changed...
            echo "Things have changed, creating a PR"
            
            version=$(cat "$file" | yq -r ".version")
            filename=${file##*/} # "Plugin Name.yml"
            name=${filename%.*} # "Plugin Name"
            branchname=$(echo "$name-$version" | sed "s/ /_/")-$version
            
            git checkout -B "$branchname"
            git add manifests/
            git commit -m "Update $name to $version"
            git push --force
            gh pr create --fill
            git checkout -b master
          fi
        done
